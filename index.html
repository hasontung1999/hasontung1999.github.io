<!DOCTYPE html>
<html>
	<head>
		<TITLE>HA SON TUNG</TITLE>
	</head>
	<body>
		<h1>Ha Son Tung</h1>
		<video id="v" controls loop src="peaceful.mp4" width="500" height="350"></video>
		<div>
			<canvas id="canvas1" style="border: 1px solid black" width="500" height="350"></canvas>
			&nbsp;
			<canvas id="canvas2" style="border:1px solid red" width="500" height="350"></canvas>
		</div>
		<script type="text/javascript">
			var canvas1=document.getElementById('canvas1');
			var canvas2=document.getElementById('canvas2');
			//var context=canvas1.getContext('2d');
			var width=canvas1.width;
			var height=canvas1.height;

			/*function at(x,y,w)
			{
				return x*w+y;
			}*/

			function grayScale(input,canvas) 
			{
				var inputData=input.data;
				var width=input.width;
				var length = inputData.length;
                var j = -1;
                for (var i = -1; i < length-1-width*4; ) {
                    var r = inputData[++i];
                    var g = inputData[++i];
                    var b = inputData[++i];
                    var value = 0.3 * r + 0.59 * g + 0.11 * b;
                    inputData[++j] = value;
                    inputData[++j] = value;
                    inputData[++j] = value;
                    ++i; 
                    ++j;
                }
                return input;
            }

            function sobelEdgeDetect(image,canvasPara,threshold)
            {
            	var data=image.data;
            	var kernelX=[[-1,0,1],[-2,0,2],[-1,0,1]];
                var kernelY=[[-1,-2,-1],[0,0,0],[1,2,1]];
                var kernelSize=kernelX.length;
                var rowOffset=canvasPara.width;
                var maxPixelOffset = canvasPara.width * 2 + kernelSize - 1;
                var SQRT = Math.sqrt;
        		//var ATAN2 =  Math.atan2;
        		var length = data.length - maxPixelOffset;
        		var magnitudes = canvasPara.getContext('2d').createImageData(width,height);
        		var magData=magnitudes.data;
        		//var directions = new ImageData(image.width,image.height);
        		for(var i = 0; i < length; i++)
        		{
            		// sum of each pixel * kernel value
            		var sumX = 0, sumY = 0;
            		for(var x = 0; x < kernelSize; x++)
            		{
                		for(var y = 0; y < kernelSize; y++)
                		{
                   			var px = data[i + (rowOffset * y) + x];
                    		var r = px[0];

                    		// use px[0] (i.e. R value) because grayscale anyway)
                    		sumX += r * kernelX[y][x];
                    		sumY += r * kernelY[y][x];
                		}
           			}
           			var mag = SQRT(sumX*sumX + sumY*sumY);
            		//var direction = ATAN2(sumX,sumY);
            		// compare neighbours
            		// set magnitude to 0 if doesn't exceed threshold, else set to magnitude
            		magData[i] = mag > threshold? mag : 0;
            		//directions.data[i] = mag > threshold? direction : 0;

     			}
     			return magnitudes;//, directions];
            }

            function edgeDetectorBySobel(image,canvas)
            {
            	var w=image.width;
            	var h=image.height;
            	var kernelX=[-1,0,1,-2,0,2,-1,0,1];
                var kernelY=[-1,-2,-1,0,0,0,1,2,1];
                var magnitudes = canvas.getContext('2d').createImageData(width,height);

                var inputData=image.data;
                var outputData=magnitudes.data;

                var sobelX=new Array(inputData.length/4);
                var sobelY=new Array(inputData.length/4);
                var SQRT=Math.sqrt;
                var FLOOR=Math.floor;
                var j=0
                for(var i =0;i<inputData.length;i+=4)
                {
                	var index=i-3*j;
                	var x= FLOOR(index/w);
                	var y=index%w;
                	if(x==0 || y==0||x==w-1||y==h-1)
                		continue;
                	sobelX[index]=inputData[i]*kernelX[4];
                	sobelX[index]+=inputData[((x-1)*w+y-1)<<2]*kernelX[0];
                	sobelX[index]+=inputData[((x-1)*w+y)<<2]*kernelX[1];
                	sobelX[index]+=inputData[((x-1)*w+y+1)<<2]*kernelX[2];
                	sobelX[index]+=inputData[(x*w+y-1)<<2]*kernelX[3];
                	sobelX[index]+=inputData[(x*w+y+1)<<2]*kernelX[5];
                	sobelX[index]+=inputData[((x+1)*w+y-1)<<2]*kernelX[6];
                	sobelX[index]+=inputData[((x+1)*w+y)<<2]*kernelX[7];
                	sobelX[index]+=inputData[((x+1)*w+y+1)<<2]*kernelX[8];

                	sobelY[index]=inputData[i]*kernelY[4];
                	sobelY[index]+=inputData[((x-1)*w+y-1)<<2]*kernelY[0];
                	sobelY[index]+=inputData[((x-1)*w+y)<<2]*kernelY[1];
                	sobelY[index]+=inputData[((x-1)*w+y+1)<<2]*kernelY[2];
                	sobelY[index]+=inputData[(x*w+y-1)<<2]*kernelY[3];
                	sobelY[index]+=inputData[(x*w+y+1)<<2]*kernelY[5];
                	sobelY[index]+=inputData[((x+1)*w+y-1)<<2]*kernelY[6];
                	sobelY[index]+=inputData[((x+1)*w+y)<<2]*kernelY[7];
                	sobelY[index]+=inputData[((x+1)*w+y+1)<<2]*kernelY[8];

                	value=SQRT(sobelX[index]*sobelX[index]+sobelY[index]*sobelY[index]);

                	outputData[i]=value;
                	outputData[i+1]=value;
                	outputData[i+2]=value;
                	outputData[i+3]=inputData[i+3];
                	j++;
                }
                return magnitudes;
            }

			document.addEventListener('DOMContentLoaded',function()
			{
				var v=document.getElementById('v');
				//var context=canvas1.getContext('2d');
				/*v.addEventListener('loadedmetadata',function()
				{
					this.width=canvas1.width;
					this.height=canvas1.height;
					//this.videoWidth=canvas.width;
					//this.videoHeight=canvas.height;
				});*/
				var draw=function(image,canvas)
				{
					var context=canvas.getContext('2d');
					context.drawImage(image,0,0,width,height);
				}
				v.addEventListener('play',function()
				{
					(function loop()
					{
					if(v.paused||v.ended) return;
					draw(v,canvas1);
					var image=canvas1.getContext('2d').getImageData(0,0,width,height);

					//var image=new Image(v);
					var imageGray=grayScale(image,canvas2);
					//canvas2.getContext('2d').putImageData(imageGray,0,0);
					//draw(imageGray,canvas2);

					//var imageSobel=canvas2.getContext('2d').getImageData(0,0,width,height);
					//console.log(imageGray);
					var edge=edgeDetectorBySobel(imageGray,canvas2);
					console.log(edge);
					canvas2.getContext('2d').putImageData(edge,0,0);
					setTimeout(loop,1000/50); //fps 50
					})();
				});

			});
		</script>
	</body>
</html>

